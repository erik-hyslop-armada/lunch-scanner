<!DOCTYPE html>
<html lang="sv" class="scroll-smooth">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Armada Lunch Ticket Scanner</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    boxShadow: { soft: '0 8px 30px rgba(2,6,23,0.06)' }
                }
            }
        };
    </script>

    <!-- html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 antialiased">

<!-- Header -->
<header class="w-full border-b border-slate-200/70 dark:border-slate-700/50 bg-white/70 dark:bg-slate-900/50 backdrop-blur">
    <div class="mx-auto max-w-xl px-4 py-5">
        <h1 class="text-2xl font-semibold tracking-tight md:text-3xl">Armada Lunch Ticket Scanner</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Point the camera at the QR code</p>
    </div>
</header>

<main class="mx-auto w-full max-w-xl px-4 py-6">
    <!-- Steg 1: namn -->
    <section id="setup" class="p-6 space-y-4 bg-white dark:bg-slate-800 rounded-2xl shadow-soft">
        <h2 class="text-lg font-medium">Who is scanning?</h2>
        <div class="flex gap-2">
            <label class="sr-only" for="nameInput">Your name</label>
            <input id="nameInput" class="flex-1 rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-3 focus:ring-2 focus:ring-amber-500 outline-none bg-white dark:bg-slate-900" placeholder="Your name" />
            <button id="saveNameBtn" class="rounded-xl bg-amber-500 hover:bg-amber-600 text-white px-5 py-3 font-semibold transition-colors">Save</button>
        </div>
        <p class="text-xs text-slate-500 dark:text-slate-400">Your name will be logged with each scan.</p>
    </section>

    <!-- Steg 2: scanner -->
    <section id="scanner" class="hidden mt-6 flex-col items-center">
        <div class="relative w-full overflow-hidden rounded-2xl shadow-soft bg-black/5 dark:bg-white/5">
            <div id="reader" class="aspect-[4/3] w-full"></div>

            <!-- siktruta -->
            <div class="pointer-events-none absolute inset-0 grid place-items-center">
                <div class="w-[300px] h-[300px] rounded-xl border-4 border-amber-400/90 shadow-[0_0_0_9999px_rgba(0,0,0,0.18)]"></div>
            </div>
        </div>

        <!-- status -->
        <div id="statusCard" role="status" aria-live="polite"
             class="w-full mt-4 p-4 rounded-2xl bg-slate-100 dark:bg-slate-800/70 border border-slate-200 dark:border-slate-700 flex items-center gap-3">
            <svg id="statusIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
            <span id="statusText" class="text-sm font-medium">Camera loading…</span>
            <span id="statusPill" class="ml-auto hidden rounded-full px-2.5 py-1 text-xs font-medium"></span>
        </div>

        <!-- detaljer från API -->
        <div id="ticketDetails" class="w-full mt-3 hidden">
            <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/70 p-4 text-sm">
                <div class="flex flex-wrap items-center gap-x-3 gap-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-500">Company: </span><span id="detCompany" class="font-medium"></span>
                        <!-- SPECIAL-badge (visas bara om special=true) -->
                        <span id="detSpecial" class="hidden rounded-full bg-rose-600/10 text-rose-700 dark:text-rose-200 dark:bg-rose-500/15 px-2 py-0.5 text-[11px] font-semibold tracking-wide">SPECIAL</span>
                    </div>
                    <div><span class="text-slate-500">Day: </span><span id="detDay" class="font-medium"></span></div>
                    <div><span class="text-slate-500">Time: </span><span id="detSlot" class="font-medium"></span></div>
                    <div class="truncate"><span class="text-slate-500">Token: </span><span id="detToken" class="font-mono"></span></div>
                </div>
                <div id="specialNote" class="hidden mt-2 text-xs font-medium text-rose-700 dark:text-rose-300">
                    Special – show in kitchen
                </div>
                <div id="metaRow" class="mt-2 hidden flex flex-wrap gap-x-6 gap-y-2">
                    <div><span class="text-slate-500">Checked in: </span><span id="detCheckedAt" class="font-medium"></span></div>
                    <div><span class="text-slate-500">Checked by: </span><span id="detCheckedBy" class="font-medium"></span></div>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="mt-auto py-8 text-center text-xs text-slate-400">
    THS Armada © <span id="year"></span>
</footer>

<script>
    /* ===================== Konfiguration ===================== */
    const WEBAPP_URL        = "https://script.google.com/macros/s/AKfycbwDAj5M9tv3zcPR6J0pgmoqFYyxgjMWyhOpMqEP9yZtTWFxY_slbvkOaMeBcER9oT03zg/exec"; // BYT vid behov
    const RESUME_DELAY      = 400;   // ms tills kameran återstartas
    const JSONP_TIMEOUT_MS  = 6000;

    /* ===================== Elementreferenser ===================== */
    const els = {
        setup:      document.getElementById('setup'),
        nameInput:  document.getElementById('nameInput'),
        saveBtn:    document.getElementById('saveNameBtn'),
        scannerSec: document.getElementById('scanner'),
        statusTxt:  document.getElementById('statusText'),
        statusIcon: document.getElementById('statusIcon'),
        statusCard: document.getElementById('statusCard'),
        statusPill: document.getElementById('statusPill'),
        year:       document.getElementById('year'),
        detWrap:    document.getElementById('ticketDetails'),
        detCompany: document.getElementById('detCompany'),
        detDay:     document.getElementById('detDay'),
        detSlot:    document.getElementById('detSlot'),
        detToken:   document.getElementById('detToken'),
        detSpecial: document.getElementById('detSpecial'),   // NEW
        specialNote:document.getElementById('specialNote'),  // NEW
        metaRow:    document.getElementById('metaRow'),
        detCheckedAt: document.getElementById('detCheckedAt'),
        detCheckedBy: document.getElementById('detCheckedBy'),
    };

    let qr; // Html5Qrcode instans
    const DEDUP_WINDOW_MS = 1500;
    let lastScan = { token: null, ts: 0 };

    /* ===================== Statushjälpare ===================== */
    function setStatus(type, msg) {
        const c = els.statusCard.classList;
        c.remove('ring-2','ring-green-500','ring-red-500','ring-yellow-400','ring-blue-500');
        els.statusIcon.classList.remove('hidden');

        // återställ pill
        els.statusPill.className = 'ml-auto hidden rounded-full px-2.5 py-1 text-xs font-medium';

        if (type === 'success') {
            c.add('ring-2','ring-green-500');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />';
            els.statusPill.textContent = 'OK';
            els.statusPill.classList.add('bg-green-100','text-green-800','dark:bg-green-900/40','dark:text-green-200','block');
        } else if (type === 'error') {
            c.add('ring-2','ring-red-500');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />';
            els.statusPill.textContent = 'Fel';
            els.statusPill.classList.add('bg-red-100','text-red-800','dark:bg-red-900/40','dark:text-red-200','block');
        } else if (type === 'repeat') {
            c.add('ring-2','ring-blue-500');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M5 15a7 7 0 0012-4M19 9A7 7 0 007 13" />';
            els.statusPill.textContent = 'Samma';
            els.statusPill.classList.add('bg-blue-100','text-blue-800','dark:bg-blue-900/40','dark:text-blue-200','block');
        } else {
            c.add('ring-2','ring-yellow-400');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />';
            els.statusPill.textContent = 'Väntar';
            els.statusPill.classList.add('bg-amber-100','text-amber-800','dark:bg-amber-900/40','dark:text-amber-200','block');
        }
        els.statusTxt.textContent = msg;
    }

    /* ===================== Detalj-rendering ===================== */
    function renderDetails(data) {
        // Rensa/visa wrapper
        els.detWrap.classList.remove('hidden');

        const t = data?.ticket || {};
        const m = data?.meta || {};

        els.detCompany.textContent = t.company || '—';
        els.detDay.textContent     = t.day != null ? String(t.day) : '—';
        els.detSlot.textContent    = formatSlot(t.slot);
        els.detToken.textContent   = t.token || '—';

        // NEW: visa/hide SPECIAL-badge + kort notis
        const isSpecial = !!t.special;
        if (isSpecial) {
            els.detSpecial.classList.remove('hidden');
            els.specialNote.classList.remove('hidden');
        } else {
            els.detSpecial.classList.add('hidden');
            els.specialNote.classList.add('hidden');
        }

        if (m.checked_in_at || m.checked_by) {
            els.metaRow.classList.remove('hidden');
            els.detCheckedAt.textContent = m.checked_in_at || '—';
            els.detCheckedBy.textContent = m.checked_by || '—';
        } else {
            els.metaRow.classList.add('hidden');
            els.detCheckedAt.textContent = '';
            els.detCheckedBy.textContent = '';
        }
    }

    function formatSlot(slot) {
        // backend kan skicka "11"/"12"/"13" eller 11/12/13
        const s = String(slot || '').trim();
        if (s === '11' || s === '12' || s === '13') return s + ':00';
        return s || '—';
    }

    /* ===================== Token-extraktion ===================== */
    // Tillåt: ren token, eller "...?t=TOKEN" / "...?token=TOKEN"
    function extractToken(qrText) {
        const paramMatch = qrText.match(/(?:^|[?&#])(t|token)=([^&#]+)/i);
        const raw = paramMatch ? decodeURIComponent(paramMatch[2]) : qrText.trim();
        if (!/^[A-Za-z0-9_-]{6,128}$/.test(raw)) throw new Error('Invalid token.');
        return raw;
    }

    /* ===================== JSONP-klient (CORS-fritt) ===================== */
    function jsonp(url, timeoutMs = JSONP_TIMEOUT_MS) {
        return new Promise((resolve, reject) => {
            const cb = 'cb_' + Math.random().toString(36).slice(2);
            const s  = document.createElement('script');
            let settled = false;

            window[cb] = (data) => {
                if (settled) return;
                settled = true;
                cleanup();
                resolve(data);
            };

            const timer = setTimeout(() => {
                if (settled) return;
                settled = true;
                if (s && s.parentNode) s.parentNode.removeChild(s);
                reject(new Error('Timeout'));
            }, timeoutMs);

            function cleanup() {
                clearTimeout(timer);
                setTimeout(() => { try { delete window[cb]; } catch {} }, 5000);
                if (s && s.parentNode) s.parentNode.removeChild(s);
            }

            s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + encodeURIComponent(cb);
            s.async = true;
            s.onerror = () => {
                if (settled) return;
                settled = true;
                cleanup();
                reject(new Error('Network error'));
            };
            document.head.appendChild(s);
        });
    }

    /* ===================== Initiera scanner ===================== */
    async function initScanner() {
        els.scannerSec.classList.remove('hidden');
        setStatus('waiting', 'Initiating camera…');

        qr = new Html5Qrcode('reader', { verbose: false });

        try {
            const cams = await Html5Qrcode.getCameras();
            if (!cams || cams.length === 0) {
                setStatus('error', 'No camera found.');
                return;
            }
            const back = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
            const cfg  = { fps: 15, qrbox: 300, disableFlip: true };

            await qr.start({ deviceId: { exact: back.id } }, cfg, onScan, () => {});
            setStatus('waiting', 'Ready – scan a code.');
        } catch (e) {
            try {
                const cfg = { fps: 15, qrbox: 300, disableFlip: true };
                await qr.start({ facingMode: 'environment' }, cfg, onScan, () => {});
                setStatus('waiting', 'Ready – scan a code.');
            } catch (err) {
                setStatus('error', 'Camera error: ' + err);
            }
        }
    }

    /* ===================== onScan ===================== */
    async function onScan(text) {
        let token;
        try {
            token = extractToken(text);
        } catch {
            setStatus('error', 'Invalid QR-code.');
            els.detWrap.classList.add('hidden');
            return;
        }

        // Simple dedup för att kunna scanna samma fysiska kod igen med kort paus
        const now = Date.now();
        if (lastScan.token === token && (now - lastScan.ts) < DEDUP_WINDOW_MS) {
            setStatus('repeat', 'Samma kod igen – nyligen hanterad.');
            lastScan.ts = now;
            return;
        }

        try { await qr.pause(); } catch {}
        setStatus('waiting', 'Waiting on response…');

        try {
            const scannerName = (localStorage.getItem('scannerName') || '').trim();
            const url = new URL(WEBAPP_URL);
            url.searchParams.set('token', token);
            url.searchParams.set('scanner', scannerName);

            const data = await jsonp(url.toString());

            if (data && typeof data === 'object') {
                // Rendera detaljer oavsett ok/ej
                renderDetails(data);

                if (data.ok) {
                    setStatus('success', data.msg || 'Checked in');
                } else {
                    // särskilj vanliga fel vs Already used
                    const msg = data.msg || 'Fel';
                    setStatus('error', msg);
                }
            } else {
                els.detWrap.classList.add('hidden');
                setStatus('error', 'Unexpected response.');
            }
        } catch (err) {
            els.detWrap.classList.add('hidden');
            if (err && err.message === 'Timeout') setStatus('error', 'Timeout, no contact with server.');
            else setStatus('error', 'Network-/JSON-error');
        } finally {
            lastScan = { token, ts: Date.now() };
            setTimeout(() => { try { qr.resume(); } catch {} }, RESUME_DELAY);
        }
    }

    /* ===================== UI-händelser ===================== */
    const elsSave = () => {
        const name = els.nameInput.value.trim();
        if (!name) return els.nameInput.focus();
        localStorage.setItem('scannerName', name);
        els.setup.classList.add('hidden');
        initScanner();
    };
    els.saveBtn.addEventListener('click', elsSave);
    els.nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') elsSave(); });

    document.addEventListener('DOMContentLoaded', () => {
        els.year.textContent = new Date().getFullYear();
        if (localStorage.getItem('scannerName')) {
            els.setup.classList.add('hidden');
            initScanner();
        }
    });

    // Pausa/resume när fliken döljs/visas
    document.addEventListener('visibilitychange', () => {
        if (!qr) return;
        try { if (document.hidden) qr.pause(); else qr.resume(); } catch {}
    });

    // Städa upp vid stängning
    window.addEventListener('beforeunload', () => { try { qr?.stop(); } catch {} });
</script>
</body>
</html>
