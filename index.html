<!DOCTYPE html>
<html lang="sv" class="scroll-smooth">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Armada Lunch-biljett Scanner</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    boxShadow: {
                        soft: '0 8px 30px rgba(2,6,23,0.06)'
                    }
                }
            }
        };
    </script>

    <!-- html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 antialiased">

<!-- Header -->
<header class="w-full border-b border-slate-200/70 dark:border-slate-700/50 bg-white/70 dark:bg-slate-900/50 backdrop-blur">
    <div class="mx-auto max-w-xl px-4 py-5">
        <h1 class="text-2xl font-semibold tracking-tight md:text-3xl">Armada Lunch-biljett Scanner</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Rikta kameran mot QR-koden</p>
    </div>
</header>

<main class="mx-auto w-full max-w-xl px-4 py-6">
    <section id="setup" class="p-6 space-y-4 bg-white dark:bg-slate-800 rounded-2xl shadow-soft">
        <h2 class="text-lg font-medium">Vem skannar?</h2>
        <div class="flex gap-2">
            <label class="sr-only" for="nameInput">Ditt namn</label>
            <input id="nameInput" class="flex-1 rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-3 focus:ring-2 focus:ring-amber-500 outline-none bg-white dark:bg-slate-900" placeholder="Ditt namn" />
            <button id="saveNameBtn" class="rounded-xl bg-amber-500 hover:bg-amber-600 text-white px-5 py-3 font-semibold transition-colors">Spara</button>
        </div>
        <p class="text-xs text-slate-500 dark:text-slate-400">Namnet loggas tillsammans med varje skanning.</p>
    </section>

    <!-- Steg 2: scanner -->
    <section id="scanner" class="hidden mt-6 flex-col items-center">
        <div class="relative w-full overflow-hidden rounded-2xl shadow-soft bg-black/5 dark:bg-white/5">
            <div id="reader" class="aspect-[4/3] w-full"></div>

            <!-- siktruta -->
            <div class="pointer-events-none absolute inset-0 grid place-items-center">
                <div class="w-[300px] h-[300px] rounded-xl border-4 border-amber-400/90 shadow-[0_0_0_9999px_rgba(0,0,0,0.18)]"></div>
            </div>
        </div>

        <!-- status -->
        <div id="statusCard" role="status" aria-live="polite"
             class="w-full mt-4 p-4 rounded-2xl bg-slate-100 dark:bg-slate-800/70 border border-slate-200 dark:border-slate-700 flex items-center gap-3">
            <svg id="statusIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
            <span id="statusText" class="text-sm font-medium">Kamera laddas…</span>
            <span id="statusPill" class="ml-auto hidden rounded-full px-2.5 py-1 text-xs font-medium"></span>
        </div>
    </section>
</main>

<footer class="mt-auto py-8 text-center text-xs text-slate-400">
    THS Armada © <span id="year"></span>
</footer>

<script>
    /* ===================== Konfiguration ===================== */
    const WEBAPP_URL        = "https://script.google.com/macros/s/AKfycbw2TSX8ID4bfLeni0Sj2TvZFjRYUNFsDmMic1JFai9FuuEaF5aCzWKMBU0eCQrniLfvvw/exec"; // BYT vid behov
    const RESUME_DELAY      = 400;   // ms tills kameran återstartas
    const JSONP_TIMEOUT_MS  = 6000;

    /* ===================== Elementreferenser ===================== */
    const els = {
        setup:      document.getElementById('setup'),
        nameInput:  document.getElementById('nameInput'),
        saveBtn:    document.getElementById('saveNameBtn'),
        scannerSec: document.getElementById('scanner'),
        statusTxt:  document.getElementById('statusText'),
        statusIcon: document.getElementById('statusIcon'),
        statusCard: document.getElementById('statusCard'),
        statusPill: document.getElementById('statusPill'),
        year:       document.getElementById('year'),
    };

    let qr;              // Html5Qrcode instans
    const DEDUP_WINDOW_MS = 1500; // hur länge vi betraktar samma token som ”nyligen hanterad”
    let lastScan = { token: null, ts: 0 };
    let inFlight  = false;

    /* ===================== Statushjälpare ===================== */
    function setStatus(type, msg) {
        const c = els.statusCard.classList;
        c.remove('ring-2', 'ring-green-500', 'ring-red-500', 'ring-yellow-400', 'ring-blue-500');
        els.statusIcon.classList.remove('hidden');

        // återställ pill
        els.statusPill.className = 'ml-auto hidden rounded-full px-2.5 py-1 text-xs font-medium';

        if (type === 'success') {
            c.add('ring-2', 'ring-green-500');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />';
            els.statusPill.textContent = 'OK';
            els.statusPill.classList.add('bg-green-100','text-green-800','dark:bg-green-900/40','dark:text-green-200','block');
        } else if (type === 'error') {
            c.add('ring-2', 'ring-red-500');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />';
            els.statusPill.textContent = 'Fel';
            els.statusPill.classList.add('bg-red-100','text-red-800','dark:bg-red-900/40','dark:text-red-200','block');
        } else if (type === 'repeat') {
            c.add('ring-2', 'ring-blue-500');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M5 15a7 7 0 0012-4M19 9A7 7 0 007 13" />';
            els.statusPill.textContent = 'Samma';
            els.statusPill.classList.add('bg-blue-100','text-blue-800','dark:bg-blue-900/40','dark:text-blue-200','block');
        } else {
            c.add('ring-2', 'ring-yellow-400');
            els.statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />';
            els.statusPill.textContent = 'Väntar';
            els.statusPill.classList.add('bg-amber-100','text-amber-800','dark:bg-amber-900/40','dark:text-amber-200','block');
        }
        els.statusTxt.textContent = msg;
    }

    /* ===================== Token-extraktion ===================== */
    // Tillåt: ren token, eller "...?t=TOKEN" / "...?token=TOKEN"
    function extractToken(qrText) {
        const paramMatch = qrText.match(/(?:^|[?&#])(t|token)=([^&#]+)/i);
        const raw = paramMatch ? decodeURIComponent(paramMatch[2]) : qrText.trim();
        if (!/^[A-Za-z0-9_-]{6,128}$/.test(raw)) throw new Error('Ogiltig token.');
        return raw;
    }

    /* ===================== JSONP-klient (CORS-fritt) ===================== */
    function jsonp(url, timeoutMs = JSONP_TIMEOUT_MS) {
        return new Promise((resolve, reject) => {
            const cb = 'cb_' + Math.random().toString(36).slice(2);
            const s  = document.createElement('script');
            let done = false;

            const timer = setTimeout(() => {
                if (done) return;
                done = true; cleanup();
                reject(new Error('Timeout'));
            }, timeoutMs);

            function cleanup() {
                clearTimeout(timer);
                try { delete window[cb]; } catch {}
                if (s && s.parentNode) s.parentNode.removeChild(s);
            }

            window[cb] = (data) => {
                if (done) return;
                done = true; cleanup();
                resolve(data);
            };

            s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + encodeURIComponent(cb);
            s.async = true;
            s.onerror = () => {
                if (done) return;
                done = true; cleanup();
                reject(new Error('Network error'));
            };
            document.head.appendChild(s);
        });
    }

    /* ===================== Initiera scanner ===================== */
    async function initScanner() {
        els.scannerSec.classList.remove('hidden');
        setStatus('waiting', 'Initierar kamera…');

        qr = new Html5Qrcode('reader', { verbose: false });

        try {
            // Försök välja bakre kamera
            const cams = await Html5Qrcode.getCameras();
            if (!cams || cams.length === 0) {
                setStatus('error', 'Ingen kamera hittades.');
                return;
            }
            const back = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
            const cfg  = { fps: 15, qrbox: 300, disableFlip: true };

            await qr.start({ deviceId: { exact: back.id } }, cfg, onScan, () => { /* svälj decode-fel */ });
            setStatus('waiting', 'Klar – skanna en kod.');
        } catch (e) {
            // Fallback: försök med facingMode om deviceId misslyckas
            try {
                const cfg = { fps: 15, qrbox: 300, disableFlip: true };
                await qr.start({ facingMode: 'environment' }, cfg, onScan, () => {});
                setStatus('waiting', 'Klar – skanna en kod.');
            } catch (err) {
                setStatus('error', 'Kamerafelkod: ' + err);
            }
        }
    }

    /* ===================== onScan ===================== */
    async function onScan(text) {
        let token;
        try {
            token = extractToken(text);
        } catch {
            setStatus('error', 'Ogiltig QR-kod.');
            return;
        }

        // Om samma token skannats nyligen: kommunicera och hoppa över
        const now = Date.now();
        if (lastScan.token === token && (now - lastScan.ts) < DEDUP_WINDOW_MS) {
            setStatus('repeat', 'Samma kod igen – nyligen hanterad.');
            // uppdatera tidsstämpeln så att användaren kan ”pumpa” den och ändå få feedback
            lastScan.ts = now;
            return;
        }

        // Normal väg
        inFlight = true;
        try { await qr.pause(); } catch {}

        setStatus('waiting', 'Väntar på svar…');

        try {
            const scannerName = (localStorage.getItem('scannerName') || '').trim();
            const url = new URL(WEBAPP_URL);
            url.searchParams.set('token', token);
            url.searchParams.set('scanner', scannerName);

            const data = await jsonp(url.toString());
            const ok   = !!data?.ok;
            const msg  = data?.msg || (ok ? 'OK' : 'Fel');

            setStatus(ok ? 'success' : 'error', msg);
        } catch (err) {
            if (err && err.message === 'Timeout') setStatus('error', 'Timeout – ingen kontakt med servern.');
            else setStatus('error', 'Nätverks-/JSON-fel');
        } finally {
            // spara senaste token + tid oavsett utfallet
            lastScan = { token, ts: Date.now() };
            setTimeout(() => {
                inFlight = false;
                try { qr.resume(); } catch {}
            }, RESUME_DELAY);
        }
    }


    /* ===================== UI-händelser ===================== */
    els.saveBtn.addEventListener('click', () => {
        const name = els.nameInput.value.trim();
        if (!name) return els.nameInput.focus();
        localStorage.setItem('scannerName', name);
        els.setup.classList.add('hidden');
        initScanner();
    });

    document.addEventListener('DOMContentLoaded', () => {
        els.year.textContent = new Date().getFullYear();
        if (localStorage.getItem('scannerName')) {
            els.setup.classList.add('hidden');
            initScanner();
        }
    });

    // Pausa/resume när fliken döljs/visas
    document.addEventListener('visibilitychange', () => {
        if (!qr) return;
        try {
            if (document.hidden) qr.pause();
            else qr.resume();
        } catch {}
    });

    // Städa upp vid stängning
    window.addEventListener('beforeunload', () => {
        try { qr?.stop(); } catch {}
    });
</script>
</body>
</html>
