<script>
  const btn    = document.getElementById('start');
  const status = document.getElementById('status');

  function show(msg, ok){
    status.textContent = msg;
    if      (ok === true)  document.body.style.background = 'var(--ok)';
    else if (ok === false) document.body.style.background = 'var(--no)';
    else                   document.body.style.background = '#f7f7f7';
  }

  btn.addEventListener('click', () => {
    console.log('[UI] Start button clicked');
    btn.remove();

    if (typeof Html5Qrcode === 'undefined'){
      show('Camera lib failed'); console.error('Html5Qrcode undefined'); return;
    }

    const qr = new Html5Qrcode('reader');
    console.log('[QR] Html5Qrcode created');

    // JSONP callback from Apps Script
    window.scanCb = ({ok,msg}) => {
      console.log('[QR] scanCb received →', { ok, msg });
      show(msg, ok);
      setTimeout(() => {
        console.log('[QR] Resuming camera');
        qr.resume();
        show('Camera ready – point at QR');
      }, 1500);
    };

    qr.start(
      { facingMode:'environment' },
      { fps:10, qrbox:250 },
      raw => {
        console.log('[QR] onSuccess raw =', raw);
        try {
          qr.pause();                      // freeze immediately
        } catch (err){
          console.warn('[QR] pause error', err);
        }
        show('Camera paused – validating…');

        const url = decodeURIComponent(raw);
        console.log('[QR] decoded URL =', url);

        const s   = document.createElement('script');
        s.src     = url + (url.includes('?') ? '&' : '?') + 'callback=scanCb';
        s.onerror = () => {
          console.error('[QR] JSONP load failed');
          show('Network error', false);
        };
        document.head.appendChild(s);
      },
      err => {
        if (!/No MultiFormat Readers/i.test(err)){
          console.warn('[QR] onError →', err);
        }
      }
    ).then(() => {
        console.log('[QR] Camera started');
        show('Camera ready – point at QR');
      })
     .catch(e  => {
        console.error('[QR] init failed', e);
        show('Camera init failed: ' + e, false);
     });
  });
</script>
