<!--
  Armada QR‑scanner – v6
  ------------------------------------------------
  • Pausar kameran direkt efter träff ➜ visar "Waiting for response…"
  • Återupptar kameran 1,2 s efter server‑svar (eller på Resume‑knapp)
  • setStatus() har nu tre lägen: success, error, waiting
  • Färgkod: waiting = gul ring
-->
<!DOCTYPE html>
<html lang="sv" class="scroll-smooth">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Armada Lunch Ticket Scanner</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={darkMode:'media'};</script>

    <!-- html5‑qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<header class="w-full max-w-xl py-6 text-center">
    <h1 class="text-2xl font-bold md:text-3xl">Armada Lunch‑biljett Scanner</h1>
    <p class="text-sm text-slate-500 dark:text-slate-400">Rikta kameran mot QR‑koden</p>
</header>

<!-- Steg 1: namn -->
<section id="setup" class="w-full max-w-md p-6 space-y-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg">
    <h2 class="text-lg font-medium">Vem skannar?</h2>
    <div class="flex gap-2">
        <input id="nameInput" class="flex-1 rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-3 focus:ring-2 focus:ring-amber-500" placeholder="Ditt namn" />
        <button id="saveNameBtn" class="rounded-xl bg-amber-500 hover:bg-amber-600 text-white px-5 py-3 font-semibold">Spara</button>
    </div>
</section>

<!-- Steg 2: scanner -->
<section id="scanner" class="hidden w-full max-w-md flex-col items-center">
    <div class="relative mx-auto mt-6">
        <div id="reader" class="rounded-2xl overflow-hidden shadow-md"></div>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-[300px] h-[300px] rounded-lg border-4 border-amber-400"></div>
        </div>
    </div>

    <div id="statusCard" class="w-full mt-4 p-4 rounded-2xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center gap-3">
        <svg id="statusIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
        <span id="statusText" class="text-sm font-medium">Kamera laddas …</span>
    </div>
</section>

<footer class="mt-auto py-6 text-center text-xs text-slate-400">THS Armada © <span id="year"></span></footer>
<audio id="beep" src="data:audio/webm;base64,GkXfo0AgQoaBAULj…" preload="auto"></audio>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/XXXXXXXX/exec"; // BYT
    const SCAN_COOLDOWN = 50; // ms tills kameran återstartas

    const els = {
        setup:      document.getElementById('setup'),
        nameInput:  document.getElementById('nameInput'),
        saveBtn:    document.getElementById('saveNameBtn'),
        scannerSec: document.getElementById('scanner'),
        statusTxt:  document.getElementById('statusText'),
        statusIcon: document.getElementById('statusIcon'),
        statusCard: document.getElementById('statusCard'),
        beep:       document.getElementById('beep'),
    };

    let qr;

    /* ---------- status helper ---------- */
    function setStatus(type, msg) {
        const c = els.statusCard.classList;
        c.remove('ring-2','ring-green-500','ring-red-500','ring-yellow-400');
        els.statusIcon.classList.remove('hidden');

        if (type==='success') {
            c.add('ring-2','ring-green-500');
            els.statusIcon.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />';
            els.beep.currentTime=0; els.beep.play().catch(()=>{});
        } else if (type==='error') {
            c.add('ring-2','ring-red-500');
            els.statusIcon.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />';
        } else { // waiting
            c.add('ring-2','ring-yellow-400');
            els.statusIcon.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />';
        }
        els.statusTxt.textContent = msg;
    }

    /* ---------- scanner init ---------- */
    function initScanner(){
        els.scannerSec.classList.remove('hidden');
        qr = new Html5Qrcode('reader', { verbose:false });
        Html5Qrcode.getCameras().then(cams=>{
            const camId = cams[0]?.id;
            qr.start({ deviceId:{exact:camId}}, { fps:15, qrbox:300, disableFlip:true }, onScan)
                .then(()=> setStatus('waiting','Kamera redo – rikta mot QR'))
                .catch(e=> setStatus('error','Startfel: '+e));
        });
    }

    /* ---------- scan callback ---------- */
    async function onScan(text){
        // pausa kamera direkt så vi inte får flera triggers
        await qr.pause();
        setStatus('waiting','Waiting for response…');

        try{
            const scannerName = encodeURIComponent(localStorage.getItem('scannerName')||'');
            const url = new URL(text);
            url.searchParams.set('scanner', scannerName);

            const res  = await fetch(url, { mode:'cors', credentials:'omit' });
            const data = await res.json();
            setStatus(data.ok ? 'success':'error', data.msg || 'Ok');
        }catch(err){
            setStatus('error','Network/JSON‑fel');
        }

        // återstarta kameran efter kort timeout
        setTimeout(()=>qr.resume(), SCAN_COOLDOWN);
    }

    /* ---------- UI events ---------- */
    els.saveBtn.addEventListener('click',()=>{
        const name = els.nameInput.value.trim();
        if(!name) return els.nameInput.focus();
        localStorage.setItem('scannerName', name);
        els.setup.classList.add('hidden');
        initScanner();
    });

    document.addEventListener('DOMContentLoaded',()=>{
        if(localStorage.getItem('scannerName')){
            els.setup.classList.add('hidden');
            initScanner();
        }
        document.getElementById('year').textContent = new Date().getFullYear();
    });
</script>
</body>
</html>