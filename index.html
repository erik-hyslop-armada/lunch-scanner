<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Armada Lunch Ticket Scanner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --ok:#d2ffd2; --no:#ffd2d2; }
    body {
      font-family: system-ui, -apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      margin:0; padding:1rem; text-align:center; background:#f7f7f7;
      transition: background .2s;
    }
    #reader{margin:auto;margin-top:1rem;width:320px;max-width:90vw;}
    #status{margin-top:1rem;font-size:1.2rem;min-height:2.2rem;}
    button{padding:1rem 2rem;font-size:1.1rem;border:none;border-radius:8px;cursor:pointer;background:#004080;color:#fff;}
    button:active{transform:scale(0.97);}    
  </style>
</head>
<body>
  <h2>Scan lunch ticket</h2>
  <button id="start">▶️ Start scanner</button>
  <div id="reader"></div>
  <div id="status"></div>

  <!-- html5‑qrcode global build -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    const startBtn = document.getElementById('start');
    const statusEl = document.getElementById('status');

    function showMsg(txt, ok){
      statusEl.textContent = txt;
      if(ok===undefined) document.body.style.background='#f7f7f7';
      else document.body.style.background = ok ? 'var(--ok)' : 'var(--no)';
    }

    startBtn.addEventListener('click', () => {
      startBtn.remove(); // user gesture captured → can ask for camera

      if (typeof Html5Qrcode === 'undefined') {
        showMsg('Failed to load camera library.');
        return;
      }

      const qr = new Html5Qrcode('reader');

      // JSONP callback. Must be global.
      window.scanCb = ({ok,msg}) => {
        showMsg(msg, ok);
        qr.pause().then(() => setTimeout(() => qr.resume(), 1500));
      };

      qr.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        fullUrl => {  // onSuccess – full https://script.google.com/...&token=XYZ
          // inject <script> to bypass CORS via JSONP
          const s = document.createElement('script');
          s.src = fullUrl + '&callback=scanCb';
          s.onerror = () => showMsg('Network error', false);
          document.head.appendChild(s);
        },
        err => {
          if (!/No MultiFormat Readers/i.test(err)) console.warn('QR error', err);
        }
      ).then(() => showMsg('Camera ready – point at QR'))
       .catch(err => showMsg('Camera initialisation failed: '+ err));
    });
  </script>
</body>
</html>
